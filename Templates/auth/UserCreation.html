{% extends "base.html" %}
{% block title %}Create User{% endblock %}

{% block styles %}
/* ---- Page theming (subtle dark) ---- */
:root{
  --bg:#232334;
  --card:#2b2a42;
  --muted:#aab0c0;
  --accent:#8672FF;
  --border:#3a3954;
  --success:#28a745;
  --danger:#dc3545;
  --warning:#ffc107;
}
body{ background:var(--bg); color:#fff; }
.page-wrap{ padding: 16px 20px 96px; }

/* ---- Alerts (top tips) ---- */
.top-alert{
  position: sticky; top:0; z-index:1050;
  border:1px solid rgba(255,193,7,.35);
  background:rgba(255,193,7,.15); color:#ffe8a1;
  backdrop-filter: blur(6px);
}

/* ---- Card / form ---- */
.card-glass{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid var(--border);
  border-radius:16px;
  box-shadow: 0 6px 30px rgba(0,0,0,.25);
}
.card-glass .card-header{
  background:transparent; border-bottom:1px dashed var(--border);
}
.card-glass .card-footer{
  background:transparent; border-top:1px dashed var(--border);
}

/* ---- Inputs ---- */
.form-control,.form-select{
  background:#1f1e31; border:1px solid var(--border); color:#fff;
}
.form-control::placeholder{ color:#717694; }
.form-check-input{ border-color:var(--border); background:#1f1e31; }
.form-check-input:checked{ background-color:var(--accent); border-color:var(--accent); }
.input-group-text{ background:#1f1e31; color:#d5d7e2; border-color:var(--border); }

/* ---- Pills / small actions ---- */
.badge-soft{
  background: rgba(134,114,255,.15); color:#c8c3ff; border:1px solid rgba(134,114,255,.35);
}

/* ---- Multi-select buckets ---- */
.bucket{
  border:1px dashed var(--border); border-radius:12px; padding:12px;
  background:rgba(255,255,255,.02);
}
.bucket h6{ color:#cfd3e1; margin-bottom:8px; }
.bucket .mini{ color:var(--muted); font-size:.85rem; }

/* ---- Password strength ---- */
.strength{
  height:6px; border-radius:999px; background:#3a3a56; overflow:hidden;
}
.strength > div{ height:100%; width:0%; transition:width .25s ease; }

/* ---- Footer note ---- */
.footer-tip{ color:#9aa0b7; font-size:.9rem; }

/* small utilities */
.small-muted{ font-size:.9rem; color:var(--muted); }
.help{ color:#9aa0b7; }

/* make selects taller without external libs */
select[multiple]{ min-height: 160px; }
{% endblock %}

{% block content %}
<div class="page-wrap container-xxl">

  <!-- Top message bar reused for tips + validation feedback -->
  <div id="topBar" class="alert top-alert d-flex align-items-center gap-2 mb-4" role="alert" style="top:12px;">
    <i class="fa-solid fa-rotate me-1" id="topBarIcon"></i>
    <div id="topBarText">Changes apply after the user <strong>logs in again</strong>.</div>
  </div>

  <form id="userCreateForm" class="card card-glass" action="{{ url_for('user_admin.users_create_submit') }}" method="post">

    <div class="card-header d-flex align-items-center justify-content-between">
      <div>
        <h5 class="mb-0" style="color: white;">Create User</h5>
        <div class="small-muted">Add a new account and assign access by brand, category, or customer.</div>
      </div>
      <span class="badge badge-soft px-3 py-2">
        <i class="fa-solid fa-shield-halved me-1"></i> RBAC ready
      </span>
    </div>

    <div class="card-body">
      <!-- Basic info -->
      <div class="row g-4">
        <div class="col-md-4">
          <label class="form-label">Username <span class="text-danger" id="reqUser">*</span></label>
          <input name="username" id="username" class="form-control" placeholder="e.g. j.doe"
                 required pattern="^[A-Za-z0-9._-]{3,30}$">
          <div class="form-text help">3–30 chars, letters, numbers, dot, underscore, or dash.</div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Full Name <span class="text-danger" id="reqFull">*</span></label>
          <input name="fullname" id="fullname" class="form-control" placeholder="Jhon Doe" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Email <span class="text-danger">*</span></label>
          <input type="email" name="email" id="email" class="form-control" placeholder="name@company.com" required>
        </div>

        <div class="col-md-3">
          <label class="form-label">Role <span class="text-danger">*</span></label>
          <select name="role" id="role" class="form-select" required>
            <option value="" selected disabled>...</option>
            <option value="developer">Developer (all access)</option>
            <option value="admin">Admin (all access)</option>
            <option value="finance_manager">Finance Manager (can approve)</option>
            <option value="brand_manager">Brand Manager (can approve)</option>
            <option value="user">User (scoped access)</option>
          </select>
          <div class="form-text help">
            Admin/Finance see all data. Brand Manager/Finance can approve sell-out.
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Status</label>
          <div class="form-check form-switch pt-2">
            <input class="form-check-input" type="checkbox" role="switch" id="isActive" name="is_active" checked>
            <label class="form-check-label" for="isActive">Active</label>
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Department</label>
          <select name="department" id="department" class="form-select" placeholder="Supply Chain">
            <option value="" selected>...</option>
            <option value="IT">IT</option>
            <option value="Finance">Finance</option>
            <option value="Sales">Sales</option>
            <option value="Marketing">Marketing</option>
            <option value="Supply Chain">Supply Chain</option>
            <option value="Admin">Admin</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Company</label>
          <input name="company" id="company" class="form-control" placeholder="Modern Electronics">
        </div>

        <div class="col-md-6">
          <label class="form-label">Password <span class="text-danger"  id="reqPwd">*</span></label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" name="password"
                   placeholder="Create a strong password" required minlength="8">
            <button class="btn btn-outline-secondary" type="button" id="togglePwd">
              <i class="fa-regular fa-eye"></i>
            </button>
          </div>
          <div class="strength mt-2" aria-hidden="true"><div id="strengthBar"></div></div>
          <div class="form-text help">Min 8 chars. Mix of upper/lower, number, and symbol recommended.</div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Confirm Password <span class="text-danger" id="reqPwd2">*</span></label>
          <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                 placeholder="Retype password" required minlength="8">
          <div id="matchNote" class="form-text"></div>
        </div>
      </div>

      <hr class="my-4">

      <!-- Access scopes -->
      <div class="row g-4">
        <div class="col-12">
          <h6 class="mb-0">Assign Access</h6>
          <div class="small-muted">For non-elevated roles, choose at least one: Brand, Category, or Customer.</div>
          <div class="small-muted">Hold <kbd>Ctrl</kbd>/<kbd>⌘</kbd> to select multiple. Use the search boxes to narrow options.</div>
        </div>

        <!-- Brands -->
        <div class="col-lg-4">
          <div class="bucket">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="mb-0">Brand Access</h6>
              <div class="mini">
                <a href="#" class="me-2 small" data-action="select-all" data-target="#brands">Select all</a>
                <a href="#" class="small" data-action="clear" data-target="#brands">Clear</a>
              </div>
            </div>
            <input class="form-control form-control-sm my-2" placeholder="Filter brands…" data-filter="#brands">
            <select id="brands" name="brands[]" class="form-select" multiple>
              {% if brands %}
                {% for b in brands %}
                  <option value="{{ b.BrandID }}">{{ b.BrandName }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
        </div>

        <!-- Categories -->
        <div class="col-lg-4">
          <div class="bucket">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="mb-0">Category Access</h6>
              <div class="mini">
                <a href="#" class="me-2 small" data-action="select-all" data-target="#categories">Select all</a>
                <a href="#" class="small" data-action="clear" data-target="#categories">Clear</a>
              </div>
            </div>
            <input class="form-control form-control-sm my-2" placeholder="Filter categories…" data-filter="#categories">
            <select id="categories" name="categories[]" class="form-select" multiple>
              {% if categories %}
                {% for c in categories %}
                  <option value="{{ c.ID }}">{{ c.CatCode }}-{{ c.CatName }}-{{c.CatDesc}}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
        </div>

        <!-- Customers -->
        <div class="col-lg-4">
          <div class="bucket">
            <div class="d-flex align-items-center justify-content-between">
              <h6 class="mb-0">Customer Access</h6>
              <div class="mini">
                <a href="#" class="me-2 small" data-action="select-all" data-target="#customers">Select all</a>
                <a href="#" class="small" data-action="clear" data-target="#customers">Clear</a>
              </div>
            </div>
            <input class="form-control form-control-sm my-2" placeholder="Filter customers…" data-filter="#customers">
            <select id="customers" name="customers[]" class="form-select" multiple>
              {% if customers %}
                {% for cu in customers %}
                  <option value="{{ cu.CustomerID }}">{{ cu.CustCode }} — {{ cu.CustName }}  — {{ cu.LevelType }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <!-- Notifications -->
      <div class="row g-4">
        <div class="col-md-6">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="send_credentials" name="send_credentials" checked>
            <label class="form-check-label" for="send_credentials">Email credentials to user</label>
          </div>
          <!-- <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="forceReset" name="force_reset" checked>
            <label class="form-check-label" for="forceReset">Force password reset on first login</label>
          </div> -->
        </div>
        <div class="col-md-6">
          <label class="form-label">Notes (optional)</label>
          <input class="form-control" name="notes" id="notes" placeholder="Any special instructions…">
        </div>
      </div>
    </div>

    <div class="card-footer d-flex align-items-center justify-content-between">
      <div class="footer-tip">
        <i class="fa-regular fa-circle-question me-1"></i>
        Non-elevated roles require at least one scope (Brand/Category/Customer).
      </div>
      <div class="d-flex gap-2">
        <button type="reset" class="btn btn-outline-light">
          <i class="fa-regular fa-trash-can me-1"></i> Clear
        </button>
        <button type="submit" class="btn btn-primary" style="background:var(--accent); border-color:var(--accent);">
          <i class="fa-regular fa-floppy-disk me-1"></i> Create User
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}

<script>
(function(){
  const CREATOR_ROLE = JSON.parse('{{ creator_role|tojson|safe }}' || 'null');

  // --- Top bar helper -------------------------------------------------------
    const topBar = document.getElementById('topBar');
    const topBarText = document.getElementById('topBarText');
    const topBarIcon = document.getElementById('topBarIcon');
    function showTop(msg, type='info'){
      topBarText.innerHTML = msg;
      if(type==='error'){
        topBar.style.borderColor = 'rgba(220,53,69,.6)';           // red
        topBar.style.background  = 'rgba(220,53,69,.15)';
        topBarText.style.color   = '#ffd1d6';
        topBarIcon.className     = 'fa-solid fa-triangle-exclamation me-1';
      }else if(type==='success'){
        topBar.style.borderColor = 'rgba(40,167,69,.5)';           // green
        topBar.style.background  = 'rgba(40,167,69,.15)';
        topBarText.style.color   = '#d4f3dc';
        topBarIcon.className     = 'fa-solid fa-circle-check me-1';
      }else{ // info
        topBar.style.borderColor = 'rgba(255,193,7,.35)';          // yellow
        topBar.style.background  = 'rgba(255,193,7,.15)';
        topBarText.style.color   = '#ffe8a1';
        topBarIcon.className     = 'fa-solid fa-circle-info me-1';
      }
    }


  // Toggle password visibility  -------------------------------------------------------
  const tgl = document.getElementById('togglePwd');
  const pwd = document.getElementById('password');
  if(tgl && pwd){
    tgl.addEventListener('click', ()=>{
      const icon = tgl.querySelector('i');
      if(pwd.type === 'password'){ pwd.type = 'text'; icon.classList.replace('fa-eye','fa-eye-slash'); }
      else{ pwd.type = 'password'; icon.classList.replace('fa-eye-slash','fa-eye'); }
    });
  }

  // Password strength (very lightweight)  -------------------------------------------------------
  const bar = document.getElementById('strengthBar');
  function scorePass(v){
    let s = 0; if(!v) return 0;
    if(v.length>=8) s+=20;
    if(/[A-Z]/.test(v)) s+=20;
    if(/[a-z]/.test(v)) s+=20;
    if(/[0-9]/.test(v)) s+=20;
    if(/[^A-Za-z0-9]/.test(v)) s+=20;
    return s;
  }
  document.getElementById('password').addEventListener('input', (e)=>{
    const p = scorePass(e.target.value);
    bar.style.width = p+'%';
    bar.style.background = p<40?'#e55353':(p<80?'#f0ad4e':'#5cb85c');
  });

  // Confirm password match
  const confirm = document.getElementById('confirm_password');
  const matchNote = document.getElementById('matchNote');
  function checkMatch(){
    if(!pwd.value || !confirm.value){ matchNote.textContent=''; return; }
    if(pwd.value === confirm.value){
      matchNote.textContent = 'Passwords match.';
      matchNote.style.color = '#58d68d';
    }else{
      matchNote.textContent = 'Passwords do not match.';
      matchNote.style.color = '#ff7675';
    }
  }
  pwd.addEventListener('input', checkMatch);
  confirm.addEventListener('input', checkMatch);

  // Simple select filter (no external libs)
  // --- Better filtering for multi-selects (hides, does not rebuild) --------
  document.querySelectorAll('[data-filter]').forEach(inp=>{
    const sel = document.querySelector(inp.dataset.filter);
    inp.addEventListener('input', ()=>{
      const q = inp.value.toLowerCase().trim();
      Array.from(sel.options).forEach(o=>{
        const text = (o.text || '').toLowerCase();
        // keep selected items visible even if they don't match, so user sees picks
        o.hidden = (!text.includes(q) && !o.selected);
      });
    });
  });

  // --- Select all / clear (only affects currently visible options) ----------
  document.querySelectorAll('[data-action]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const sel = document.querySelector(a.dataset.target);
      if(!sel) return;
      const visibleOpts = Array.from(sel.options).filter(o => !o.hidden);
      if(a.dataset.action==='select-all'){
        visibleOpts.forEach(o=>o.selected=true);
      }else if(a.dataset.action==='clear'){
        Array.from(sel.options).forEach(o=>o.selected=false);
      }
      sel.dispatchEvent(new Event('change'));
    });
    });

  function applyRoleRules(){
    // Creator can be 'developer' → relax requirements
    const creatorIsDev = (CREATOR_ROLE === 'developer');
  
    // Make username/fullname/password optional for creator=developer
    document.getElementById('username').required = !creatorIsDev;
    document.getElementById('fullname').required = !creatorIsDev;
    document.getElementById('password').required = !creatorIsDev;
    document.getElementById('confirm_password').required = !creatorIsDev;
  
    // Update asterisks visibility
    document.getElementById('reqUser').style.visibility = creatorIsDev ? 'hidden' : 'visible';
    document.getElementById('reqFull').style.visibility = creatorIsDev ? 'hidden' : 'visible';
    document.getElementById('reqPwd').style.visibility  = creatorIsDev ? 'hidden' : 'visible';
    document.getElementById('reqPwd2').style.visibility = creatorIsDev ? 'hidden' : 'visible';
  
    // Tip text
    if (creatorIsDev) {
      showTop('As <strong>Developer</strong>, you may create a user with just <em>Email</em> + <em>Role</em>. '
        + 'If the new user is a scoped role (User/Brand Manager), pick at least one access (Brand/Category/Customer).', 'info');
    } else {
      showTop('Changes apply after the user <strong>logs in again</strong>.', 'info');
    }
  }
  

  document.getElementById('userCreateForm').addEventListener('submit', function(e){
    const creatorIsDev = (CREATOR_ROLE === 'developer');
    const targetRole   = document.getElementById('role').value;
  
    const selBrands = document.getElementById('brands');
    const selCats   = document.getElementById('categories');
    const selCusts  = document.getElementById('customers');
  
    const brands = Array.from(selBrands.selectedOptions).length;
    const cats   = Array.from(selCats.selectedOptions).length;
    const custs  = Array.from(selCusts.selectedOptions).length;
    const totalScopes = brands + cats + custs;
  
    let errors = [];
  
    // Access rule depends on the role being ASSIGNED to the new user
    const scopedRole = ['user','brand_manager'].includes(targetRole);
  
    if (creatorIsDev) {
      // Minimal required: Email + Role. Access required only if target is scoped role.
      if (!targetRole) errors.push('Please choose a role for the new user.');
      if (scopedRole && totalScopes === 0) {
        errors.push('For User/Brand Manager, select at least one access: Brand or Category or Customer.');
      }
      // Password is optional for creator=developer; if provided, must match
      const pv = document.getElementById('password').value.trim();
      const cv = document.getElementById('confirm_password').value.trim();
      if ((pv || cv) && pv !== cv) errors.push('Passwords do not match.');
    } else {
      // Non-developer creators: enforce stricter rules
      if (!targetRole) errors.push('Please choose a role for the new user.');
      if (scopedRole && totalScopes === 0) {
        errors.push('Please select at least one access scope: Brand, Category, or Customer.');
      }
      const pv = document.getElementById('password').value;
      const cv = document.getElementById('confirm_password').value;
      if (pv !== cv) errors.push('Passwords do not match.');
    }
  
    // Let HTML5 required/pattern run (these were toggled by applyRoleRules)
    if (!this.checkValidity()) {
      e.preventDefault();
      this.reportValidity();
      showTop('Please complete the required fields.', 'error');
      return;
    }
  
    if (errors.length) {
      e.preventDefault();
      showTop(errors.join(' '), 'error');
      return;
    }
  
    showTop('Submitting…', 'success');
  });

  // Init role rules on load (in case a default is pre-selected)
  applyRoleRules();
  
})();
</script>
{% endblock %}
